# HA compose: Sentinel + VIP/VRRP failover via keepalived.
# Run:
#   docker compose -f deploy/compose/docker-compose.ha.yml up -d

services:
  sentinel:
    image: ghcr.io/robotnikz/sentinel-dns:latest
    container_name: sentinel-dns
    ports:
      # DNS service (UDP/TCP). If port 53 is already in use (e.g. systemd-resolved),
      # adjust the host-side port mapping or disable the stub resolver.
      # By default this is published on all host interfaces (0.0.0.0).
      # To keep it reachable for all devices in your LAN while avoiding WAN exposure,
      # bind explicitly to your LAN interface IP (example 192.168.1.10):
      # - "192.168.1.10:53:53/udp"
      # - "192.168.1.10:53:53/tcp"
      - "53:53/udp"
      - "53:53/tcp"
      # Web UI + API
      # Same idea for the UI/API:
      # - "192.168.1.10:8080:8080"
      - "8080:8080"
    environment:
      # Timezone used for logs/UI timestamps.
      - TZ=Europe/Berlin
      # Ensure the Web UI/API is reachable via Docker port publishing.
      - HOST=0.0.0.0
      - PORT=8080
      # HA/VIP role override file written by keepalived.
      - CLUSTER_ROLE_FILE=/data/sentinel/cluster_role
    volumes:
      # Persistent storage for Postgres data, settings, secrets, and the GeoIP database.
      - sentinel-data:/data
    # Required for embedded Tailscale (VPN / exit-node mode).
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    # Required for forwarding traffic when tailscale is acting as an exit node. (full traffic via Tailscale VPN)
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv6.conf.all.forwarding: "1"
    restart: unless-stopped

  keepalived:
    image: ghcr.io/robotnikz/sentinel-dns-keepalived:latest
    container_name: sentinel-keepalived
    network_mode: host
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - NET_BROADCAST
    environment:
      - DATA_DIR=/data
      - HA_CONFIG_FILE=/data/sentinel/ha/config.json
      - HA_ROLE_FILE=/data/sentinel/cluster_role
      - HA_NETINFO_FILE=/data/sentinel/ha/netinfo.json
      - HA_READY_URL=http://127.0.0.1:8080/api/cluster/ready
    volumes:
      - sentinel-data:/data

volumes:
  sentinel-data:
